FROM lambci/lambda:build-nodejs6.10

ENV PATH /root/.yarn/bin:$PATH
RUN curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 0.24.6

ARG AWS_DEFAULT_REGION=us-east-1
ARG NICBOT_KMS_KEY=ca682fa1-7275-443c-8f1d-0016c4595e37
ARG AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ARG AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ARG ENVIRONMENT=${ENVIRONMENT}
ARG FUNCTION=${FUNCTION}
ENV AWS_DEFAULT_REGION us-east-1
ENV NICBOT_KMS_KEY ca682fa1-7275-443c-8f1d-0016c4595e37
ENV AWS_ACCESS_KEY_ID ${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY ${AWS_SECRET_ACCESS_KEY}
ENV FUNCTION ${FUNCTION}
ENV ENVIRONMENT ${ENVIRONMENT}

COPY . .

RUN yarn global add serverless
RUN sls config credentials -p aws -k ${AWS_ACCESS_KEY_ID} -s ${AWS_SECRET_ACCESS_KEY} -n serverless --env ${ENVIRONMENT}

CMD bash ./bin/docker/deploy.sh ${ENVIRONMENT} ${FUNCTION}
