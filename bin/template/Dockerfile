FROM lambci/lambda:build-nodejs6.10

ENV PATH /root/.yarn/bin:$PATH
RUN curl -o- -L https://yarnpkg.com/install.sh | bash

ARG AWS_DEFAULT_REGION=ap-southeast-2
ARG KMS_KEY=875adc1e-f3c4-449c-98c1-5c6283bd6e24
ARG AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ARG AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ARG ENVIRONMENT=${ENVIRONMENT}
ARG FUNCTION=${FUNCTION}
ENV AWS_DEFAULT_REGION ap-southeast-2
ENV KMS_KEY 875adc1e-f3c4-449c-98c1-5c6283bd6e24
ENV AWS_ACCESS_KEY_ID ${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY ${AWS_SECRET_ACCESS_KEY}
ENV FUNCTION ${FUNCTION}
ENV ENVIRONMENT ${ENVIRONMENT}

COPY . .

RUN yarn global add serverless
RUN sls config credentials -p aws -k ${AWS_ACCESS_KEY_ID} -s ${AWS_SECRET_ACCESS_KEY} -n serverless --env ${ENVIRONMENT}

CMD bash ./bin/docker/deploy.sh ${ENVIRONMENT} ${FUNCTION}
